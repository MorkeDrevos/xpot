// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Enums
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

enum TicketStatus {
  IN_DRAW
  WON
  CLAIMED
  NOT_PICKED
  EXPIRED
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Models
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model User {
  id         String   @id @default(cuid())
  createdAt  DateTime @default(now())

  // Optional Clerk user id (for auth)
  clerkId    String?  @unique

  // X identity â€“ all optional so we can still have system / test users
  xId        String?  @unique     // X account id
  xHandle    String?  @unique     // @handle
  xName      String?              // display name
  xAvatarUrl String?              // avatar URL

  wallets    Wallet[]
  tickets    Ticket[]
}

model Wallet {
  id         String          @id @default(cuid())
  address    String          @unique
  userId     String
  user       User            @relation(fields: [userId], references: [id])
  createdAt  DateTime        @default(now())

  balances   XpUserBalance[]
  tickets    Ticket[]
}

model XpUserBalance {
  id        String   @id @default(cuid())
  walletId  String   @unique
  wallet    Wallet   @relation(fields: [walletId], references: [id])
  balance   Int
  updatedAt DateTime @updatedAt
}

model Draw {
  id             String   @id @default(cuid())
  drawDate       DateTime @unique          // one main draw per day
  isClosed       Boolean  @default(false)
  resolvedAt     DateTime?

  // Main jackpot size for this draw (XPOT amount, stored in jackpotUsd column)
  jackpotUsd     Int?

  // Payout info for the main winner
  paidAt         DateTime?
  payoutTx       String?

  // All tickets in this draw
  tickets        Ticket[] @relation("DrawTickets")

  // Winning ticket (when resolved)
  winnerTicketId String?  @unique
  winnerTicket   Ticket?  @relation("DrawWinner", fields: [winnerTicketId], references: [id])

  // Extra hype / bonus jackpots linked to this draw
  rewards        Reward[]
}

model Ticket {
  id        String       @id @default(cuid())
  code      String       @unique
  createdAt DateTime     @default(now())

  // Status of this ticket in the lifecycle
  status    TicketStatus @default(IN_DRAW)

  // Draw this ticket belongs to
  drawId    String
  draw      Draw         @relation("DrawTickets", fields: [drawId], references: [id])

  // Owning user (X identity)
  userId    String
  user      User         @relation(fields: [userId], references: [id])

  // Wallet that claimed it
  // â— optional, because X can exist before wallet connect
  walletId  String?
  wallet    Wallet?      @relation(fields: [walletId], references: [id])

  // If this ticket is the main winner of a draw
  winnerOf  Draw?        @relation("DrawWinner")

  // Any bonus jackpots this ticket has won
  rewards   Reward[]

  // ğŸ” HARD LOCK: one ticket per wallet per draw
  @@unique([drawId, walletId], name: "OneTicketPerWalletPerDraw")
}

// Bonus / hype jackpots attached to a daily draw
model Reward {
  id         String   @id @default(cuid())
  createdAt  DateTime @default(now())

  drawId     String
  draw       Draw     @relation(fields: [drawId], references: [id])

  ticketId   String
  ticket     Ticket   @relation(fields: [ticketId], references: [id])

  // e.g. "Bonus jackpot", "Flash pot", "Stream giveaway"
  label      String

  // XPOT amount for this reward (token amount, not USD)
  payoutXpot Int

  isPaidOut  Boolean  @default(false)

  // Store transaction link for this reward payout
  txUrl      String?  @map("payoutTx")
}

enum BonusDropStatus {
  SCHEDULED
  FIRED
  CANCELLED
}

model BonusDrop {
  id          String          @id @default(cuid())
  createdAt   DateTime        @default(now())

  // When this bonus is supposed to fire (used for countdown + worker)
  scheduledAt DateTime

  // Display label â€“ e.g. "Bonus XPOT", "Stream bonus"
  label       String

  // XPOT amount (token amount, not USD)
  amountXpot  Int

  status      BonusDropStatus @default(SCHEDULED)

  // Optional link to the Reward that actually paid it out (once fired)
  rewardId    String?
  reward      Reward?         @relation(fields: [rewardId], references: [id])
}
