// prisma/schema.prisma

// ─────────────────────────────────────────────
// Generator & datasource
// ─────────────────────────────────────────────

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─────────────────────────────────────────────
// Enums
// ─────────────────────────────────────────────

enum TicketStatus {
  IN_DRAW
  WON
  CLAIMED
  NOT_PICKED
  EXPIRED
}

enum BonusDropStatus {
  SCHEDULED
  FIRED
  CANCELLED
}

enum WinnerKind {
  MAIN
  BONUS
}

// ─────────────────────────────────────────────
// Models
// ─────────────────────────────────────────────

// App user – can be linked to Clerk + X + wallets
model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Optional Clerk user id (for auth)
  clerkId   String?  @unique

  // Optional X identity – all nullable so we can still have system / test users
  xUserId    String?  @unique
  xHandle    String?  @unique
  xName      String?
  xAvatarUrl String?

  // Relations
  wallets Wallet[]
  tickets Ticket[]
}

// Solana wallet – tied to a user (optional)
model Wallet {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  address   String   @unique

  userId    String?
  user      User?    @relation(fields: [userId], references: [id])

  tickets   Ticket[]

  @@index([userId])
}

// One XPOT draw per day
model Draw {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Calendar date of the draw (unique per day)
  date      DateTime @unique

  // When the main XPOT closes for this day
  closesAt  DateTime?

  // Simple string status: "open" | "closed" | "completed"
  status    String   @default("open")

  // Relations
  tickets    Ticket[]
  winners    Winner[]

  // Scheduled bonus drops that conceptually belong to this draw
  bonusDrops BonusDrop[]
}

// XPOT entry ticket
model Ticket {
  id          String       @id @default(cuid())
  createdAt   DateTime     @default(now())

  code        String       @unique

  // Wallet that owns this ticket (by relation + raw address copy)
  walletId    String?
  wallet      Wallet?      @relation(fields: [walletId], references: [id])

  walletAddress String

  status      TicketStatus @default(IN_DRAW)

  // Link to the draw this ticket participates in
  drawId      String
  draw        Draw         @relation(fields: [drawId], references: [id])

  winners     Winner[]

  @@index([walletId])
  @@index([drawId])
  @@index([status])
}

// Main + bonus winners log
model Winner {
  id          String      @id @default(cuid())
  createdAt   DateTime    @default(now())

  // Draw + ticket relations
  drawId      String
  draw        Draw        @relation(fields: [drawId], references: [id])

  ticketId    String
  ticket      Ticket      @relation(fields: [ticketId], references: [id])

  // Snapshot fields for convenience
  date          DateTime    @default(now())
  ticketCode    String
  walletAddress String

  // Jackpot and payout accounting (stored as USD-equivalent or XPOT-equivalent)
  jackpotUsd   Float       @default(0)
  payoutUsd    Float       @default(0)

  isPaidOut    Boolean     @default(false)
  txUrl        String?

  kind         WinnerKind?
  label        String?

  @@index([drawId])
  @@index([ticketId])
  @@index([isPaidOut])
  @@index([kind])
}

// Scheduled bonus XPOT drops for a given draw
model BonusDrop {
  id          String          @id @default(cuid())
  createdAt   DateTime        @default(now())

  drawId      String
  draw        Draw            @relation(fields: [drawId], references: [id])

  label       String
  amountXpot  Int
  scheduledAt DateTime

  status      BonusDropStatus @default(SCHEDULED)

  @@index([drawId])
  @@index([status, scheduledAt])
}
