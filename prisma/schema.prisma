// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ─────────────────────────────────────────────
// Enums
// ─────────────────────────────────────────────

enum TicketStatus {
  IN_DRAW
  WON
  CLAIMED
  NOT_PICKED
  EXPIRED
}

enum BonusDropStatus {
  SCHEDULED
  FIRED
  CANCELLED
}

enum WinnerKind {
  MAIN
  BONUS
}

// ─────────────────────────────────────────────
// Models
// ─────────────────────────────────────────────

// User (optional identity, NOT tied to tickets)
model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  clerkId    String?  @unique
  xUserId    String?  @unique
  xHandle    String?  @unique
  xName      String?
  xAvatarUrl String?

  wallets    Wallet[]

  @@index([xHandle])
}

// Wallet → owns tickets
model Wallet {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  address   String   @unique

  userId    String?
  user      User?    @relation(fields: [userId], references: [id])

  tickets   Ticket[]

  @@index([userId])
}

// Daily XPOT draw
model Draw {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  /// Calendar date of the draw (UTC day bucket)
  drawDate  DateTime @unique

  /// When the main XPOT closes for entries
  closesAt  DateTime?

  /// "open" / "closed" / "completed"
  status    String   @default("open")

  tickets    Ticket[]
  winners    Winner[]
  bonusDrops BonusDrop[]
}

// XPOT ticket in a draw
model Ticket {
  id            String       @id @default(cuid())
  createdAt     DateTime     @default(now())

  code          String       @unique

  // Ticket must always have an owning wallet
  walletId      String
  wallet        Wallet       @relation(fields: [walletId], references: [id])

  // Snapshot of wallet address at creation time
  walletAddress String

  status        TicketStatus @default(IN_DRAW)

  drawId        String
  draw          Draw         @relation(fields: [drawId], references: [id])

  winners       Winner[]

  @@index([walletId])
  @@index([drawId])
  @@index([status])
  @@index([walletAddress])
}

// Log of main + bonus winners
model Winner {
  id            String      @id @default(cuid())
  createdAt     DateTime    @default(now())

  drawId        String
  draw          Draw        @relation(fields: [drawId], references: [id])

  ticketId      String
  ticket        Ticket      @relation(fields: [ticketId], references: [id])

  // Optional extra timestamp (you already have createdAt)
  date          DateTime    @default(now())

  // Snapshots (keep them - makes rendering fast and stable)
  ticketCode    String
  walletAddress String

  jackpotUsd    Float       @default(0)
  payoutUsd     Float       @default(0)
  isPaidOut     Boolean     @default(false)
  txUrl         String?

  // Never null
  kind          WinnerKind  @default(MAIN)
  label         String?

  @@index([drawId])
  @@index([ticketId])
  @@index([isPaidOut])
  @@index([kind])
  @@index([walletAddress])
}

// Scheduled bonus XPOT drops
model BonusDrop {
  id          String          @id @default(cuid())
  createdAt   DateTime        @default(now())

  drawId      String
  draw        Draw            @relation(fields: [drawId], references: [id])

  label       String
  amountXpot  Int
  scheduledAt DateTime

  status      BonusDropStatus @default(SCHEDULED)

  @@index([drawId])
  @@index([status, scheduledAt])
}
