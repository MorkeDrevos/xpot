// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─────────────────────────────────────────────
// Enums
// ─────────────────────────────────────────────

enum TicketStatus {
  IN_DRAW
  WON
  CLAIMED
  NOT_PICKED
  EXPIRED
}

enum BonusDropStatus {
  SCHEDULED
  FIRED
  CANCELLED
}

enum WinnerKind {
  MAIN
  BONUS
}

// ─────────────────────────────────────────────
// Models
// ─────────────────────────────────────────────

// User (optional identity, NOT tied to tickets)
model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  clerkId    String? @unique
  xUserId    String? @unique
  xHandle    String? @unique
  xName      String?
  xAvatarUrl String?

  wallets    Wallet[]   // users can have wallets
}

// Wallet → owns tickets
model Wallet {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  address   String   @unique

  userId    String?
  user      User?    @relation(fields: [userId], references: [id])

  tickets   Ticket[]

  @@index([userId])
}

// Daily XPOT draw
model Draw {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Calendar date of the draw (uniquely one per day)
  date      DateTime @unique

  // When the main XPOT closes for this day
  closesAt  DateTime?
  // "open" | "closed" | "completed"
  status    String   @default("open")

  // Relations
  tickets    Ticket[]
  winners    Winner[]
  bonusDrops BonusDrop[]
}

// XPOT ticket in a draw
model Ticket {
  id            String       @id @default(cuid())
  createdAt     DateTime     @default(now())

  code          String       @unique

  // Wallet that owns this ticket (by relation)
  walletId      String?
  wallet        Wallet?      @relation(fields: [walletId], references: [id])

  // Snapshot of wallet address for this ticket
  walletAddress String

  status        TicketStatus @default(IN_DRAW)

  // Link to the draw this ticket participates in
  drawId        String
  draw          Draw         @relation(fields: [drawId], references: [id])

  // Winners that reference this ticket (main + bonus)
  winners       Winner[]

  @@index([walletId])
  @@index([drawId])
  @@index([status])
}

// Log of main + bonus winners
model Winner {
  id            String      @id @default(cuid())
  createdAt     DateTime    @default(now())

  drawId        String
  draw          Draw        @relation(fields: [drawId], references: [id])

  ticketId      String
  ticket        Ticket      @relation(fields: [ticketId], references: [id])

  // Denormalized snapshot fields
  date          DateTime    @default(now())
  ticketCode    String
  walletAddress String

  jackpotUsd    Float       @default(0)
  payoutUsd     Float       @default(0)
  isPaidOut     Boolean     @default(false)
  txUrl         String?

  kind          WinnerKind?
  label         String?

  @@index([drawId])
  @@index([ticketId])
  @@index([isPaidOut])
  @@index([kind])
}

// Scheduled bonus XPOT drops
model BonusDrop {
  id          String          @id @default(cuid())
  createdAt   DateTime        @default(now())

  drawId      String
  draw        Draw            @relation(fields: [drawId], references: [id])

  label       String
  amountXpot  Int
  scheduledAt DateTime

  status      BonusDropStatus @default(SCHEDULED)

  @@index([drawId])
  @@index([status, scheduledAt])
}
