// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ─────────────────────────────────────────────
// Enums
// ─────────────────────────────────────────────

enum TicketStatus {
  IN_DRAW
  WON
  CLAIMED
  NOT_PICKED
  EXPIRED
}

enum BonusDropStatus {
  SCHEDULED
  FIRED
  CANCELLED
}

enum WinnerKind {
  MAIN
  BONUS
}

enum OpsMode {
  MANUAL
  AUTO
}

// ─────────────────────────────────────────────
// Core models
// ─────────────────────────────────────────────

model OpsConfig {
  singleton String @id @default("singleton")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  mode OpsMode @default(MANUAL)
}

model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  clerkId    String @unique
  xUserId    String? @unique
  xHandle    String? @unique
  xName      String?
  xAvatarUrl String?

  wallets     Wallet[]
  preference  UserPreference?
  hubStreak   HubStreak?

  @@index([xHandle])
}

model Wallet {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  address String @unique

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  tickets Ticket[]

  @@index([userId])
}

model Draw {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  drawDate DateTime @unique
  closesAt DateTime?
  status String @default("open")

  tickets    Ticket[]
  winners    Winner[]
  bonusDrops BonusDrop[]
  entries    DrawEntry[]
}

model Ticket {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  code String @unique

  walletId String
  wallet   Wallet @relation(fields: [walletId], references: [id])

  walletAddress String
  status TicketStatus @default(IN_DRAW)

  drawId String
  draw   Draw @relation(fields: [drawId], references: [id])

  winners Winner[]

  @@unique([walletId, drawId])
  @@index([walletId, drawId, status, walletAddress])
}

model Winner {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  drawId String
  draw   Draw   @relation(fields: [drawId], references: [id])

  ticketId String
  ticket   Ticket @relation(fields: [ticketId], references: [id])

  ticketCode    String
  walletAddress String

  jackpotUsd Float   @default(0)
  payoutUsd  Float   @default(0)
  isPaidOut  Boolean @default(false)
  txUrl      String?

  kind  WinnerKind @default(MAIN)
  label String?

  @@index([drawId, ticketId, walletAddress])
}

model BonusDrop {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  drawId String
  draw   Draw   @relation(fields: [drawId], references: [id])

  label       String
  amountXpot  Int
  scheduledAt DateTime
  status BonusDropStatus @default(SCHEDULED)

  @@index([drawId, status, scheduledAt])
}

model DrawEntry {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  drawId String
  draw   Draw   @relation(fields: [drawId], references: [id])

  clerkId String
  xHandle String
  xName   String?
  xAvatarUrl String?

  @@unique([drawId, clerkId])
  @@index([drawId, xHandle])
}

// ─────────────────────────────────────────────
// Hub personalization
// ─────────────────────────────────────────────

model UserPreference {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  soundEnabled Boolean @default(true)
}

model HubStreak {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  days        Int @default(0)
  lastDoneDay DateTime?
}

model DailyMission {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  ymd   String @unique
  title String
  desc  String

  @@index([ymd])
}
